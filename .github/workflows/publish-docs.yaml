name: Publish Documentation

on:
    push:
        branches:
            - main

env:
    SOPS_AGE_KEY: ${{ secrets.AGE_SECRET_KEY }}

jobs:
    publish-docs:
        runs-on: ubuntu-latest

        steps:
            - name: Install SOPS
              env:
                  SOPS_VERSION: v3.11.0
              run: |
                  curl -LO https://github.com/getsops/sops/releases/download/${SOPS_VERSION}/sops-${SOPS_VERSION}.linux.amd64
                  sudo mv sops-${SOPS_VERSION}.linux.amd64 /usr/local/bin/sops
                  sudo chmod +x /usr/local/bin/sops

            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - run: git config --global user.email "thijsfranck@aureliusenterprise.com"
            - run: git config --global user.name "Thijs Franck"

            - uses: actions/setup-python@v5
              with:
                  python-version: 3.14

            - name: Install uv
              run: python -m pip install uv

            - name: Cache the virtualenv
              uses: actions/cache@v4
              with:
                  path: ./.venv
                  key: ${{ runner.os }}-venv-${{ hashFiles('**/uv.lock') }}

            - name: Install Python dependencies
              run: uv venv --allow-existing && uv sync

            - name: Setup Node.js and dependencies
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm

            - name: Install Node.js dependencies
              run: npm install

            - name: Publish documentation
              run: npx nx run-many -t docs-publish chromatic
